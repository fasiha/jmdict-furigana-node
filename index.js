"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const DOWNLOAD_INSTRUCTIONS = `Download and unzip JmdictFurigana.json.gz from https://github.com/Doublevil/JmdictFurigana.
`;
const fs_1 = require("fs");
const strip_bom_1 = __importDefault(require("strip-bom"));
const RAW_JMDICT_FILENAME = 'JmdictFurigana.json';
const READING_FILENAME = 'reading.ldjson';
const TEXT_FILENAME = 'text.ldjson';
// const JMNEDICT_FILENAME = 'JmnedictFurigana.json';
function fileOk(filename) {
    return __awaiter(this, void 0, void 0, function* () {
        try {
            const stat = yield fs_1.promises.stat(filename);
            return stat.isFile() && stat.size > 0;
        }
        catch (_a) { }
        return false;
    });
}
function normalizeFurigana(characters) {
    const furigana = [];
    const last = (arr) => arr[arr.length - 1];
    for (const char of characters) {
        if (!char) {
            continue;
        }
        if (typeof char === 'object' || typeof last(furigana) !== 'string') { // last(furigana) might be undefined
            furigana.push(char);
        }
        else {
            // via de Morgan theorem, (char=string) && last(merged)=string here
            furigana[furigana.length - 1] += char;
        }
    }
    return furigana;
}
function setter(map, key, value) {
    const hit = map.get(key);
    if (hit) {
        hit.push(value);
    }
    else {
        map.set(key, [value]);
    }
}
function setup() {
    return __awaiter(this, void 0, void 0, function* () {
        if ((yield fileOk(READING_FILENAME)) && (yield fileOk(TEXT_FILENAME))) {
            const fnameToMap = (f) => __awaiter(this, void 0, void 0, function* () { return new Map((yield fs_1.promises.readFile(f, 'utf8')).split('\n').map(s => JSON.parse(s))); });
            const readingToEntry = yield fnameToMap(READING_FILENAME);
            const textToEntry = yield fnameToMap(TEXT_FILENAME);
            return { readingToEntry, textToEntry };
        }
        if (yield fileOk(RAW_JMDICT_FILENAME)) {
            const raw = JSON.parse(strip_bom_1.default(yield fs_1.promises.readFile(RAW_JMDICT_FILENAME, 'utf8')));
            const entries = raw.map(o => [o.text, o.reading, o.furigana.map(({ ruby, rt }) => rt ? { ruby, rt } : ruby)]);
            const textToEntry = new Map();
            const readingToEntry = new Map();
            for (const entry of entries) {
                const [text, reading] = entry;
                setter(textToEntry, text, entry);
                setter(readingToEntry, reading, entry);
            }
            const mapToLdjson = (m) => Array.from(m, o => JSON.stringify(o)).join('\n');
            fs_1.promises.writeFile(READING_FILENAME, mapToLdjson(readingToEntry));
            fs_1.promises.writeFile(TEXT_FILENAME, mapToLdjson(textToEntry));
            return { readingToEntry, textToEntry };
        }
        console.error(DOWNLOAD_INSTRUCTIONS);
        process.exit(1);
    });
}
exports.setup = setup;
function furiganaToString(fs) {
    const safeRe = /[\{\}]/;
    if (fs.some(f => safeRe.test(typeof f === 'string' ? f : f.ruby + f.rt))) {
        throw new Error('Furigana contains {markup}');
    }
    return fs.map(f => typeof f === 'string' ? f : `{${f.ruby}}^{${f.rt}}`).join('');
}
exports.furiganaToString = furiganaToString;
function stringToFurigana(s) {
    const chars = s.split('');
    const re = /{(.+?)}\^{(.+?)}/g;
    let match;
    while (match = re.exec(s)) {
        const index = match.index || 0; // TypeScript pacification
        chars[index] = { ruby: match[1], rt: match[2] };
        for (let i = index + 1; i < index + match[0].length; i++) {
            chars[i] = '';
        }
    }
    return normalizeFurigana(chars);
}
exports.stringToFurigana = stringToFurigana;
if (module === require.main) {
    (function main() {
        return __awaiter(this, void 0, void 0, function* () {
            const { textToEntry, readingToEntry } = yield setup();
            console.log(textToEntry.get('漢字'));
            console.log(readingToEntry.get('だいすき'));
        });
    })();
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7OztBQUFBLE1BQU0scUJBQXFCLEdBQ3ZCO0NBQ0gsQ0FBQztBQUVGLDJCQUE0QjtBQUM1QiwwREFBaUM7QUFFakMsTUFBTSxtQkFBbUIsR0FBRyxxQkFBcUIsQ0FBQztBQUNsRCxNQUFNLGdCQUFnQixHQUFHLGdCQUFnQixDQUFDO0FBQzFDLE1BQU0sYUFBYSxHQUFHLGFBQWEsQ0FBQztBQUVwQyxxREFBcUQ7QUFFckQsU0FBZSxNQUFNLENBQUMsUUFBZ0I7O1FBQ3BDLElBQUk7WUFDRixNQUFNLElBQUksR0FBRyxNQUFNLGFBQVEsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDM0MsT0FBTyxJQUFJLENBQUMsTUFBTSxFQUFFLElBQUksSUFBSSxDQUFDLElBQUksR0FBRyxDQUFDLENBQUM7U0FDdkM7UUFBQyxXQUFNLEdBQUU7UUFDVixPQUFPLEtBQUssQ0FBQztJQUNmLENBQUM7Q0FBQTtBQVNELFNBQVMsaUJBQWlCLENBQUMsVUFBc0I7SUFDL0MsTUFBTSxRQUFRLEdBQVMsRUFBRSxDQUFDO0lBQzFCLE1BQU0sSUFBSSxHQUFHLENBQUMsR0FBUyxFQUFFLEVBQUUsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQztJQUNoRCxLQUFLLE1BQU0sSUFBSSxJQUFJLFVBQVUsRUFBRTtRQUM3QixJQUFJLENBQUMsSUFBSSxFQUFFO1lBQUUsU0FBUztTQUFFO1FBQ3hCLElBQUksT0FBTyxJQUFJLEtBQUssUUFBUSxJQUFJLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLFFBQVEsRUFBRSxFQUFFLG9DQUFvQztZQUN4RyxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQ3JCO2FBQU07WUFDTCxtRUFBbUU7WUFDbkUsUUFBUSxDQUFDLFFBQVEs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SyxDQUFDLEtBQUssSUFBSSxDQUFDLENBQUMsQ0FBQywwQkFBMEI7UUFDMUQsS0FBSyxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFDLENBQUM7UUFDOUMsS0FBSyxJQUFJLENBQUMsR0FBRyxLQUFLLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxLQUFLLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUFFLEtBQUssQ0FBQyxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUM7U0FBRTtLQUM3RTtJQUNELE9BQU8saUJBQWlCLENBQUMsS0FBSyxDQUFDLENBQUM7QUFDbEMsQ0FBQztBQVZELDRDQVVDO0FBRUQsSUFBSSxNQUFNLEtBQUssT0FBTyxDQUFDLElBQUksRUFBRTtJQUMzQixDQUFDLFNBQWUsSUFBSTs7WUFDbEIsTUFBTSxFQUFDLFdBQVcsRUFBRSxjQUFjLEVBQUMsR0FBRyxNQUFNLEtBQUssRUFBRSxDQUFDO1lBQ3BELE9BQU8sQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ25DLE9BQU8sQ0FBQyxHQUFHLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFBO1FBQ3pDLENBQUM7S0FBQSxDQUFDLEVBQUUsQ0FBQztDQUNOIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgRE9XTkxPQURfSU5TVFJVQ1RJT05TID1cbiAgICBgRG93bmxvYWQgYW5kIHVuemlwIEptZGljdEZ1cmlnYW5hLmpzb24uZ3ogZnJvbSBodHRwczovL2dpdGh1Yi5jb20vRG91YmxldmlsL0ptZGljdEZ1cmlnYW5hLlxuYDtcblxuaW1wb3J0IHtwcm9taXNlc30gZnJvbSAnZnMnO1xuaW1wb3J0IHN0cmlwQm9tIGZyb20gJ3N0cmlwLWJvbSc7XG5cbmNvbnN0IFJBV19KTURJQ1RfRklMRU5BTUUgPSAnSm1kaWN0RnVyaWdhbmEuanNvbic7XG5jb25zdCBSRUFESU5HX0ZJTEVOQU1FID0gJ3JlYWRpbmcubGRqc29uJztcbmNvbnN0IFRFWFRfRklMRU5BTUUgPSAndGV4dC5sZGpzb24nO1xuXG4vLyBjb25zdCBKTU5FRElDVF9GSUxFTkFNRSA9ICdKbW5lZGljdEZ1cmlnYW5hLmpzb24nO1xuXG5hc3luYyBmdW5jdGlvbiBmaWxlT2soZmlsZW5hbWU6IHN0cmluZykge1xuICB0cnkge1xuICAgIGNvbnN0IHN0YXQgPSBhd2FpdCBwcm9taXNlcy5zdGF0KGZpbGVuYW1lKTtcbiAgICByZXR1cm4gc3RhdC5pc0ZpbGUoKSAmJiBzdGF0LnNpemUgPiAwO1xuICB9IGNhdGNoIHt9XG4gIHJldHVybiBmYWxzZTtcbn1cblxuZXhwb3J0IHR5cGUgUnVieSA9IHtcbiAgcnVieTogc3RyaW5nOyBydDogc3RyaW5nO1xufTtcbmV4cG9ydCB0eXBlIEZ1cmlnYW5hID0gc3RyaW5nfFJ1Ynk7XG5leHBvcnQgdHlwZSBFbnRyeSA9IFtzdHJpbmcsIHN0cmluZywgRnVyaWdhbmFbXV07XG50eXBlIFdvcmQgPSBGdXJpZ2FuYVtdO1xuXG5mdW5jdGlvbiBub3JtYWxpemVGdXJpZ2FuYShjaGFyYWN0ZXJzOiBGdXJpZ2FuYVtdKTogRnVyaWdhbmFbXSB7XG4gIGNvbnN0IGZ1cmlnYW5hOiBXb3JkID0gW107XG4gIGNvbnN0IGxhc3QgPSAoYXJyOiBXb3JkKSA9PiBhcnJbYXJyLmxlbmd0aCAtIDFdO1xuICBmb3IgKGNvbnN0IGNoYXIgb2YgY2hhcmFjdGVycykge1xuICAgIGlmICghY2hhcikgeyBjb250aW51ZTsgfVxuICAgIGlmICh0eXBlb2YgY2hhciA9PT0gJ29iamVjdCcgfHwgdHlwZW9mIGxhc3QoZnVyaWdhbmEpICE9PSAnc3RyaW5nJykgeyAvLyBsYXN0KGZ1cmlnYW5hKSBtaWdodCBiZSB1bmRlZmluZWRcbiAgICAgIGZ1cmlnYW5hLnB1c2goY2hhcik7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIHZpYSBkZSBNb3JnYW4gdGhlb3JlbSwgKGNoYXI9c3RyaW5nKSAmJiBsYXN0KG1lcmdlZCk9c3RyaW5nIGhlcmVcbiAgICAgIGZ1cmlnYW5hW2Z1cmlnYW5hLmxlbmd0aCAtIDFdICs9IGNoYXI7XG4gICAgfVxuICB9XG4gIHJldHVybiBmdXJpZ2FuYTtcbn1cblxuZnVuY3Rpb24gc2V0dGVyPEssIFY+KG1hcDogTWFwPEssIFZbXT4sIGtleTogSywgdmFsdWU6IFYpIHtcbiAgY29uc3QgaGl0ID0gbWFwLmdldChrZXkpO1xuICBpZiAoaGl0KSB7XG4gICAgaGl0LnB1c2godmFsdWUpO1xuICB9IGVsc2Uge1xuICAgIG1hcC5zZXQoa2V5LCBbdmFsdWVdKTtcbiAgfVxufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gc2V0dXAoKTogUHJvbWlzZTx7cmVhZGluZ1RvRW50cnk6IE1hcDxzdHJpbmcsIEVudHJ5W10+OyB0ZXh0VG9FbnRyeTogTWFwPHN0cmluZywgRW50cnlbXT47fT4ge1xuICBpZiAoKGF3YWl0IGZpbGVPayhSRUFESU5HX0ZJTEVOQU1FKSkgJiYgKGF3YWl0IGZpbGVPayhURVhUX0ZJTEVOQU1FKSkpIHtcbiAgICBjb25zdCBmbmFtZVRvTWFwID0gYXN5bmMgKGY6IHN0cmluZykgPT5cbiAgICAgICAgbmV3IE1hcCgoYXdhaXQgcHJvbWlzZXMucmVhZEZpbGUoZiwgJ3V0ZjgnKSkuc3BsaXQoJ1xcbicpLm1hcChzID0+IEpTT04ucGFyc2UocykgYXMgW3N0cmluZywgRW50cnlbXV0pKTtcbiAgICBjb25zdCByZWFkaW5nVG9FbnRyeSA9IGF3YWl0IGZuYW1lVG9NYXAoUkVBRElOR19GSUxFTkFNRSk7XG4gICAgY29uc3QgdGV4dFRvRW50cnkgPSBhd2FpdCBmbmFtZVRvTWFwKFRFWFRfRklMRU5BTUUpO1xuICAgIHJldHVybiB7cmVhZGluZ1RvRW50cnksIHRleHRUb0VudHJ5fTtcbiAgfVxuICBpZiAoYXdhaXQgZmlsZU9rKFJBV19KTURJQ1RfRklMRU5BTUUpKSB7XG4gICAgdHlwZSBSYXdFbnRyeSA9IHt0ZXh0OiBzdHJpbmcsIHJlYWRpbmc6IHN0cmluZywgZnVyaWdhbmE6IHtydWJ5OiBzdHJpbmcsIHJ0Pzogc3RyaW5nfVtdfTtcbiAgICBjb25zdCByYXc6IFJhd0VudHJ5W10gPSBKU09OLnBhcnNlKHN0cmlwQm9tKGF3YWl0IHByb21pc2VzLnJlYWRGaWxlKFJBV19KTURJQ1RfRklMRU5BTUUsICd1dGY4JykpKTtcbiAgICBjb25zdCBlbnRyaWVzOiBFbnRyeVtdID0gcmF3Lm1hcChvID0+IFtvLnRleHQsIG8ucmVhZGluZywgby5mdXJpZ2FuYS5tYXAoKHtydWJ5LCBydH0pID0+IHJ0ID8ge3J1YnksIHJ0fSA6IHJ1YnkpXSk7XG5cbiAgICBjb25zdCB0ZXh0VG9FbnRyeTogTWFwPHN0cmluZywgRW50cnlbXT4gPSBuZXcgTWFwKCk7XG4gICAgY29uc3QgcmVhZGluZ1RvRW50cnk6IE1hcDxzdHJpbmcsIEVudHJ5W10+ID0gbmV3IE1hcCgpO1xuICAgIGZvciAoY29uc3QgZW50cnkgb2YgZW50cmllcykge1xuICAgICAgY29uc3QgW3RleHQsIHJlYWRpbmddID0gZW50cnk7XG4gICAgICBzZXR0ZXIodGV4dFRvRW50cnksIHRleHQsIGVudHJ5KTtcbiAgICAgIHNldHRlcihyZWFkaW5nVG9FbnRyeSwgcmVhZGluZywgZW50cnkpO1xuICAgIH1cblxuICAgIGNvbnN0IG1hcFRvTGRqc29uID0gKG06IHR5cGVvZiB0ZXh0VG9FbnRyeSkgPT4gQXJyYXkuZnJvbShtLCBvID0+IEpTT04uc3RyaW5naWZ5KG8pKS5qb2luKCdcXG4nKTtcbiAgICBwcm9taXNlcy53cml0ZUZpbGUoUkVBRElOR19GSUxFTkFNRSwgbWFwVG9MZGpzb24ocmVhZGluZ1RvRW50cnkpKTtcbiAgICBwcm9taXNlcy53cml0ZUZpbGUoVEVYVF9GSUxFTkFNRSwgbWFwVG9MZGpzb24odGV4dFRvRW50cnkpKTtcblxuICAgIHJldHVybiB7cmVhZGluZ1RvRW50cnksIHRleHRUb0VudHJ5fTtcbiAgfVxuICBjb25zb2xlLmVycm9yKERPV05MT0FEX0lOU1RSVUNUSU9OUyk7XG4gIHByb2Nlc3MuZXhpdCgxKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGZ1cmlnYW5hVG9TdHJpbmcoZnM6IEZ1cmlnYW5hW10pOiBzdHJpbmcge1xuICBjb25zdCBzYWZlUmUgPSAvW1xce1xcfV0vO1xuICBpZiAoZnMuc29tZShmID0+IHNhZmVSZS50ZXN0KHR5cGVvZiBmID09PSAnc3RyaW5nJyA/IGYgOiBmLnJ1YnkgKyBmLnJ0KSkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0Z1cmlnYW5hIGNvbnRhaW5zIHttYXJrdXB9Jyk7XG4gIH1cbiAgcmV0dXJuIGZzLm1hcChmID0+IHR5cGVvZiBmID09PSAnc3RyaW5nJyA/IGYgOiBgeyR7Zi5ydWJ5fX1eeyR7Zi5ydH19YCkuam9pbignJyk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzdHJpbmdUb0Z1cmlnYW5hKHM6IHN0cmluZyk6IEZ1cmlnYW5hW10ge1xuICBjb25zdCBjaGFyczogRnVyaWdhbmFbXSA9IHMuc3BsaXQoJycpO1xuICBjb25zdCByZSA9IC97KC4rPyl9XFxeeyguKz8pfS9nO1xuICBsZXQgbWF0Y2g6IFJlZ0V4cE1hdGNoQXJyYXl8bnVsbDtcbiAgd2hpbGUgKG1hdGNoID0gcmUuZXhlYyhzKSkge1xuICAgIGNvbnN0IGluZGV4ID0gbWF0Y2guaW5kZXggfHwgMDsgLy8gVHlwZVNjcmlwdCBwYWNpZmljYXRpb25cbiAgICBjaGFyc1tpbmRleF0gPSB7cnVieTogbWF0Y2hbMV0sIHJ0OiBtYXRjaFsyXX07XG4gICAgZm9yIChsZXQgaSA9IGluZGV4ICsgMTsgaSA8IGluZGV4ICsgbWF0Y2hbMF0ubGVuZ3RoOyBpKyspIHsgY2hhcnNbaV0gPSAnJzsgfVxuICB9XG4gIHJldHVybiBub3JtYWxpemVGdXJpZ2FuYShjaGFycyk7XG59XG5cbmlmIChtb2R1bGUgPT09IHJlcXVpcmUubWFpbikge1xuICAoYXN5bmMgZnVuY3Rpb24gbWFpbigpIHtcbiAgICBjb25zdCB7dGV4dFRvRW50cnksIHJlYWRpbmdUb0VudHJ5fSA9IGF3YWl0IHNldHVwKCk7XG4gICAgY29uc29sZS5sb2codGV4dFRvRW50cnkuZ2V0KCfmvKLlrZcnKSk7XG4gICAgY29uc29sZS5sb2cocmVhZGluZ1RvRW50cnkuZ2V0KCfjgaDjgYTjgZnjgY0nKSlcbiAgfSkoKTtcbn0iXX0=